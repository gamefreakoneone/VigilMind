// remember npm run build and/or npm run watch to bundle with webpack
import { Readability } from "@mozilla/readability";

showLoadingScreen();

// Wait for page to load
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", extractAndSend);
} else {
  extractAndSend();
}

function showLoadingScreen() {
  const overlay = document.createElement("div");
  overlay.id = "parental-supervisor-overlay";
  overlay.innerHTML = `
    <style>
      #parental-supervisor-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.98);
        z-index: 2147483647;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      }
      .loading-content {
        text-align: center;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .loading-text {
        font-size: 18px;
        color: #333;
        font-weight: 500;
      }
    </style>
    <div class="loading-content">
      <div class="spinner"></div>
      <div class="loading-text">Checking content safety...</div>
    </div>
  `;
  document.documentElement.appendChild(overlay);
}

function removeLoadingScreen() {
  const overlay = document.getElementById("parental-supervisor-overlay");
  if (overlay) {
    overlay.remove();
  }
}

function extractAndSend() {
  // Clone document for Readability
  const documentClone = document.cloneNode(true);
  const article = new Readability(documentClone).parse();

  const pageData = {
    url: window.location.href,
    title: document.title,
    content: article ? article.textContent : document.body.innerText,
    timestamp: Date.now(),
  };

    console.log('=== EXTRACTED PAGE DATA ===');
    console.log('URL:', pageData.url);
    console.log('Title:', pageData.title);
    console.log('Content preview:', pageData.content.substring(0, 500));
    console.log('Full content length:', pageData.content.length);
    console.log('Full data:', pageData);

  //   Send to Python backend
  fetch("http://localhost:5000/analyze", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(pageData),
  })
    .then((response) => response.json())
    .then((data) => {
      console.log("Analysis result:", data);
      // Could block page or show warning if inappropriate
    })
    .catch((error) => {
      console.error("Error:", error);
      blockPage("Error analyzing content. Please try again later.");
    });
}

function blockPage(reason) {
  // Replace entire page with blocking message TODO: Also add a text box for the student to appeal.
  document.documentElement.innerHTML = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Content Blocked</title>
      <style>
        body {
          margin: 0;
          padding: 0;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          display: flex;
          align-items: center;
          justify-content: center;
          min-height: 100vh;
          color: white;
        }
        .container {
          text-align: center;
          padding: 40px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 20px;
          backdrop-filter: blur(10px);
          max-width: 600px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .icon {
          font-size: 80px;
          margin-bottom: 20px;
        }
        h1 {
          margin: 0 0 20px 0;
          font-size: 32px;
        }
        p {
          font-size: 18px;
          margin: 10px 0;
          opacity: 0.9;
        }
        .reason {
          background: rgba(255, 255, 255, 0.2);
          padding: 15px;
          border-radius: 10px;
          margin: 20px 0;
          font-size: 16px;
        }
        button {
          background: white;
          color: #667eea;
          border: none;
          padding: 15px 30px;
          font-size: 16px;
          border-radius: 25px;
          cursor: pointer;
          font-weight: bold;
          margin-top: 20px;
          transition: transform 0.2s;
        }
        button:hover {
          transform: scale(1.05);
        }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="icon">üõ°Ô∏è</div>
        <h1>Content Blocked</h1>
        <p>This website has been blocked by your parental controls.</p>
        <div class="reason">
          <strong>Reason:</strong> ${reason}
        </div>
        <p>If you believe this is a mistake, please talk to your parent or guardian.</p>
        <button onclick="history.back()">Go Back</button>
      </div>
    </body>
    </html>
  `;
}
